(()=>{"use strict";const t=50;class e{constructor(t,e){this.canvas=t,this.context=e,this.shapes=[],this.movingShape=void 0}moveShapeDown(){this.thereIsRoomToMoveDown()&&this.movingShape.moveDown()}moveShapeLeft(){this.thereIsRoomToMoveLeft()&&this.movingShape.moveLeft()}moveShapeRight(){this.thereIsRoomToMoveRight()&&this.movingShape.moveRight()}moveShapeToBottom(){for(;this.thereIsRoomToMoveDown();)this.moveShapeDown()}noOtherShapeIsInTheWayDown(){const e=this.movingShape.squares.map((t=>t.point));for(const s of this.shapes)if(s!==this.movingShape){const i=s.squares.map((t=>t.point));if(e.filter((e=>i.some((s=>s.x===e.x&&s.y===e.y+t)))).length>0)return!1}return!0}noOtherShapeIsInTheWayLeft(){const e=this.movingShape.squares.map((t=>t.point));for(const s of this.shapes)if(s!==this.movingShape){const i=s.squares.map((t=>t.point));if(e.filter((e=>i.some((s=>s.x+t===e.x&&s.y===e.y)))).length>0)return!1}return!0}noOtherShapeIsInTheWayRight(){const e=this.movingShape.squares.map((t=>t.point));for(const s of this.shapes)if(s!==this.movingShape){const i=s.squares.map((t=>t.point));if(e.filter((e=>i.some((s=>s.x===e.x+t&&s.y===e.y)))).length>0)return!1}return!0}rotateShape(){this.movingShape.clear(),this.movingShape.rotateClockwise(),this.allPointsFitInsideGrid()&&this.noOtherShapeIsInTheWay(this.movingShape)||this.movingShape.rotateCounterClockwise(),this.movingShape.draw()}allPointsFitInsideGrid(){return this.movingShape.squares.map((t=>t.point.x)).every((e=>e>=0&&e<=this.canvas.width-t))&&this.movingShape.squares.map((t=>t.point.y)).every((e=>e>=0&&e<=this.canvas.height-t))}thereIsRoomToMoveDown(){return this.movingShape.getLargestY()+t<this.canvas.height&&this.noOtherShapeIsInTheWayDown()}thereIsRoomToMoveLeft(){return this.movingShape.getSmallestX()-t>=0&&this.noOtherShapeIsInTheWayLeft()}thereIsRoomToMoveRight(){return this.movingShape.getLargestX()+t<this.canvas.width&&this.noOtherShapeIsInTheWayRight()}removeFullRows(){const e=this.canvas.width/t,s=this.canvas.height/t;let i=0;for(let a=0;a<s;a+=1){const s=new Map;for(const e of this.shapes)for(const i of e.squares)i.point.y===a*t&&s.set(i,e);if(s.size===e){i+=1;for(const[t,e]of s)t.clear(),e.remove(t);this.shiftDownward(a)}}return i}shiftDownward(e){const s=e*t;for(const t of this.shapes)t.clearAndMoveSquaresBelowYLimit(s)&&t.draw()}noOtherShapeIsInTheWay(t){for(const e of this.shapes)if(e!==t&&e.hasCommonPointWith(t))return!1;return!0}drawLines(){const e=this.canvas.height/t;for(let s=1;s<e;s+=1)this.context.strokeStyle="black",this.context.beginPath(),this.context.moveTo(0,s*t),this.context.lineTo(this.canvas.width,s*t),this.context.stroke()}drawAllPoints(){for(const t of this.shapes)t.drawPoints()}drawCoordinates(){for(const t of this.shapes)t.drawCoordinates()}hasOccupiedPoint(t,e){return this.shapes.map((s=>s.hasOccupiedPoint(t,e))).includes(!0)}print(){let e="";for(let s=0;s<this.canvas.height;s+=t){let i="";for(let e=0;e<this.canvas.width;e+=t)this.hasOccupiedPoint(e,s)?i+="⬛":i+="⬜";s!==this.canvas.height-t&&(i+="\n"),e+=i}return e}}class s{constructor(){this.high=s.getHighScore(),document.getElementById("high-score").innerText=this.high,this.current=0}static getHighScore(){let t=localStorage.getItem("tetris-high");return void 0===t&&(t=0),t}static calculateIncrease(t){return 2**t+2}increment(t){this.current+=t,document.getElementById("current-score").innerText=this.current}get(){return this.current}set(t){this.current=t}submit(){this.current>this.high&&(localStorage.setItem("tetris-high",this.current),document.getElementById("high-score").innerText=this.current)}}class i{constructor(){this.value=0,this.delay=1e3}increase(){this.value+=1,this.delay=1e3-100*this.value}increaseIfNecessary(t){return t>this.value&&(this.increase(),document.getElementById("speedContainer").classList.add("shaken"),setTimeout((()=>document.getElementById("speedContainer").classList.remove("shaken")),1e3)),this.value}}class a{constructor(t,e,s){this.canvas=t,this.context=e,this.shapeGenerator=s}init(){this.setCanvasWidth(),this.setCanvasHeight(),window.setTimeout((()=>{document.getElementById("loading").hidden=!0,document.getElementById("container").style.display="grid"}),200),this.grid=new e(this.canvas,this.context);const t=this.shapeGenerator.generateShape();this.grid.shapes.push(t),this.grid.movingShape=t,t.draw(),this.score=new s,this.speed=new i,document.getElementById("current-speed").innerText=this.speed.value,this.SCORE_PER_SPEED_INCREASE=50,this.MAX_SPEED=9,this.paused=t=>{if(this.grid.movingShape)switch(t.key){case"p":this.pause()}},this.keyPressed=t=>{if(this.grid.movingShape)switch(t.key){case"j":this.grid.moveShapeLeft();break;case"k":this.grid.rotateShape();break;case"l":this.grid.moveShapeRight();break;case" ":if(window.clearInterval(this.heartbeatInterval),this.heartbeatInterval=void 0,this.grid.moveShapeToBottom(),!this.grid.thereIsRoomToMoveDown()){this.grid.movingShape=void 0;const t=this.grid.removeFullRows();t>0&&(this.requestScoreIncrease(t),this.requestSpeedIncrease());const e=this.shapeGenerator.generateShape();this.grid.noOtherShapeIsInTheWay(e)?(this.grid.shapes.push(e),e.draw(),this.grid.movingShape=e):this.end()}this.grid.movingShape&&void 0===this.heartbeatInterval&&(this.heartbeatInterval=window.setInterval((()=>a.heartbeat()),a.speed.delay));break;case"1":this.grid.drawAllPoints();break;case"2":this.grid.drawCoordinates();break;case"3":this.grid.movingShape.drawEdgePoints();break;case"4":this.grid.drawLines()}},this.keyHandler=this.keyPressed.bind(this),window.addEventListener("keypress",this.keyHandler),this.pauseKeyHandler=this.paused.bind(this),window.addEventListener("keypress",this.pauseKeyHandler);const a=this;this.heartbeatInterval=window.setInterval((()=>a.heartbeat()),a.speed.delay),this.isPaused=!1}setCanvasWidth(){500<window.screen.availWidth&&(this.canvas.width=500)}setCanvasHeight(){let t=window.screen.availHeight;t%100!=0&&(t-=t%100),t-=100,t>1e3&&(t=1e3),this.canvas.height=t}heartbeat(){if(!this.grid.thereIsRoomToMoveDown()){this.grid.movingShape=void 0;const t=this.grid.removeFullRows();t>0&&(this.requestScoreIncrease(t),this.requestSpeedIncrease());const e=this.shapeGenerator.generateShape();this.grid.noOtherShapeIsInTheWay(e)?(this.grid.shapes.push(e),e.draw(),this.grid.movingShape=e):this.end()}this.grid.movingShape&&this.grid.thereIsRoomToMoveDown()&&this.grid.moveShapeDown()}end(){this.score.submit(),a.showGameOverText(),window.clearInterval(this.heartbeatInterval),window.removeEventListener("keypress",this.keyHandler),window.removeEventListener("keypress",this.pauseKeyHandler)}requestSpeedIncrease(){if(this.speed.value<this.MAX_SPEED){const t=this.speed.value,e=Math.trunc(this.score.get()/this.SCORE_PER_SPEED_INCREASE);if(this.speed.increaseIfNecessary(e)>t){window.clearInterval(this.heartbeatInterval);const t=this;this.heartbeatInterval=window.setInterval((()=>t.heartbeat()),t.speed.delay),document.getElementById("current-speed").innerText=this.speed.value}}}requestScoreIncrease(t){this.score.increment(t)}pause(){if(this.isPaused){window.addEventListener("keypress",this.keyHandler);const t=this;this.heartbeatInterval=window.setInterval((()=>t.heartbeat()),this.speed.delay)}else window.clearInterval(this.heartbeatInterval),window.removeEventListener("keypress",this.keyHandler);this.isPaused=!this.isPaused}static showGameOverText(){document.getElementById("gameOverContainer").hidden=!1}}class n{constructor(t,e){this.x=t,this.y=e}moveDown(){this.y+=t}moveLeft(){this.x+=-50}moveRight(){this.x+=t}transformClockwise(t,e){this.translate(-t,-e),this.rotateClockwise(),this.translate(t,e)}transformCounterClockwise(t,e){this.translate(-t,-e),this.rotateCounterClockwise(),this.translate(t,e)}translate(t,e){this.x=this.x+t,this.y=this.y+e}rotateClockwise(){const t=this.x,e=this.y;this.x=-e,this.y=t}rotateCounterClockwise(){const t=this.x,e=this.y;this.x=e,this.y=-t}equals(t){return t instanceof n&&"number"==typeof t.x&&"number"==typeof t.y&&this.x===t.x&&this.y===t.y}occupiesCoordinates(t,e){return this.x===t&&this.y===e}}class h{constructor(e,s,i){this.point=e,this.fillStyle=s,this.context=i,this.sideLength=t}draw(){this.context.beginPath(),this.context.fillStyle=this.fillStyle,this.context.fillRect(this.point.x,this.point.y,this.sideLength,this.sideLength)}drawPoint(){this.context.beginPath(),this.context.strokeStyle="red",this.context.arc(this.point.x,this.point.y,10,0,2*Math.PI),this.context.stroke()}drawCoordinates(){this.context.fillStyle="black",this.context.fillText(`${this.point.x} | ${this.point.y}`,this.point.x,this.point.y)}drawEdgePoints(){this.drawEdgePoint("yellow",this.point.x,this.point.y),this.drawEdgePoint("blue",this.point.x+t,this.point.y),this.drawEdgePoint("magenta",this.point.x+t,this.point.y+t),this.drawEdgePoint("black",this.point.x,this.point.y+t)}drawEdgePoint(t,e,s){this.context.beginPath(),this.context.strokeStyle=t,this.context.arc(e,s,10,0,2*Math.PI),this.context.stroke()}clear(){this.context.clearRect(this.point.x,this.point.y,this.sideLength,this.sideLength)}equals(t){return void 0!==t&&t instanceof h&&this.sideLength===t.sideLength&&this.point.equals(t.point)}moveDown(){this.clear(),this.point.moveDown(),this.draw()}clearAndMoveDown(){this.clear(),this.point.moveDown()}moveLeft(){this.clear(),this.point.moveLeft(),this.draw()}moveRight(){this.clear(),this.point.moveRight(),this.draw()}transformClockwise(t,e){this.point.transformClockwise(t,e)}transformCounterClockwise(t,e){this.point.transformCounterClockwise(t,e)}isBelowLimit(t){return this.point.y<t}hasOccupiedPoint(t,e){return this.point.occupiesCoordinates(t,e)}}class r{init(t,e,s,i){this.pointOfTranslation=e;const a=new h(e,t,i),n=s.map((e=>new h(e,t,i)));this.squares=[a,...n],this.largestY=this.calculateLargestY(),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX(),this.context=i}getPointOfTranslationX(){return this.getPointOfTranslationX}remove(t){Object.prototype.hasOwnProperty.call(t,"point")&&Object.prototype.hasOwnProperty.call(t.point,"x")&&Object.prototype.hasOwnProperty.call(t.point,"y")&&(this.squares=this.squares.filter((e=>!e.equals(t))),this.largestY=this.calculateLargestY(),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX())}draw(){this.squares.forEach((t=>t.draw()))}drawPoints(){this.squares.forEach((t=>t.drawPoint()))}drawCoordinates(){this.squares.forEach((t=>t.drawCoordinates()))}markPointOfTranslation(){this.context.fillStyle="rgba(120, 230, 244, 0.2)",this.context.beginPath(),this.context.arc(this.pointOfTranslation.x,this.pointOfTranslation.y,10,0,2*Math.PI),this.context.stroke()}drawEdgePoints(){this.squares.forEach((t=>{t.drawEdgePoints()}))}clear(){this.squares.forEach((t=>t.clear()))}rotateClockwise(){this.squares.forEach((t=>{t.transformClockwise(this.pointOfTranslation.x,this.pointOfTranslation.y)})),this.largestY=this.calculateLargestY(),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX()}rotateCounterClockwise(){this.squares.forEach((t=>{t.transformCounterClockwise(this.pointOfTranslation.x,this.pointOfTranslation.y)})),this.largestY=this.calculateLargestY(),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX()}hasPoint(t){const e=this.squares.map((t=>new n(t.point.x,t.point.y))).filter((e=>e.equals(t)));return void 0!==e&&e.length&&0!==e.length&&e.equals(t)}hasCommonPointWith(t){for(const e of this.squares)for(const s of t.squares)if(e.equals(s))return!0;return!1}moveDown(){this.clear(),this.squares.forEach((t=>t.moveDown())),this.largestY=this.calculateLargestY(),this.draw()}moveLeft(){this.clear(),this.squares.forEach((t=>t.moveLeft())),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX(),this.draw()}moveRight(){this.clear(),this.squares.forEach((t=>t.moveRight())),this.smallestX=this.calculateSmallestX(),this.largestX=this.calculateLargestX(),this.draw()}calculateLargestY(){return this.squares.map((t=>t.point.y)).sort().pop()}calculateSmallestX(){return this.squares.map((t=>t.point.x)).sort().shift()}calculateLargestX(){return this.squares.map((t=>t.point.x)).sort().pop()}getLargestY(){return this.largestY}getSmallestX(){return this.smallestX}getLargestX(){return this.largestX}clearAndMoveSquaresBelowYLimit(t){let e=!1;return this.squares.forEach((s=>{s.isBelowLimit(t)&&(s.clearAndMoveDown(),e=!0)})),e}hasOccupiedPoint(t,e){return this.squares.map((s=>s.hasOccupiedPoint(t,e))).includes(!0)}}const o={I:class extends r{constructor(e,s){super();const i=new n(e,0),a=[new n(e-100,0),new n(e-t,0),new n(e+t,0)];super.init("yellowgreen",i,a,s)}},O:class extends r{constructor(e,s){super();const i=new n(e-t,0),a=new n(e,0),h=new n(e-t,t),r=new n(e,t),o=[i,a,h];super.init("thistle",r,o,s)}rotateClockwise(){}rotateCounterClockwise(){}},L:class extends r{constructor(e,s){super();const i=new n(e-100,0),a=new n(e-t,0),h=[i,new n(e,0),new n(e-100,t)];super.init("lightblue",a,h,s)}},J:class extends r{constructor(e,s){super();const i=new n(e-t,0),a=new n(e,0),h=[i,new n(e+t,0),new n(e+t,t)];super.init("darksalmon",a,h,s)}},S:class extends r{constructor(e,s){super();const i=new n(e-t,0),a=new n(e,0),h=new n(e-100,t),r=new n(e-t,t),o=[i,a,h];super.init("khaki",r,o,s)}},Z:class extends r{constructor(e,s){super();const i=new n(e-t,0),a=new n(e,0),h=new n(e,t),r=[i,a,new n(e+t,t)];super.init("tan",h,r,s)}},T:class extends r{constructor(e,s){super();const i=new n(e-t,t),a=new n(e,t),h=[i,new n(e+t,t),new n(e,0)];super.init("lightgrey",a,h,s)}}},c=document.createElement("canvas");c.setAttribute("id","gameCanvas"),document.getElementById("gameContainer").append(c);const l=c.getContext("2d"),d=new class{constructor(t,e){this.canvas=t,this.context=e}generateShape(){const t=Object.values(o);return new(0,t[Math.round(Math.random()*(t.length-1))])(this.canvas.width/2,this.context)}}(c,l);new a(c,l,d).init()})();
//# sourceMappingURL=main.js.map